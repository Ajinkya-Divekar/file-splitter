<div *ngIf="isLoading" class="loading-overlay">
  <p>🔄 Processing documents... Please wait.</p>
</div>

<div class="pdf-container">
  <pdf-viewer
    class="pdf-viewer"
    [hidden]="!pdfLoaded"
    [src]="pdfSrc"
    [zoom]="0.75"
    [page]="1"
    [show-all]="false"
    [original-size]="true"
    [render-text]="false"
    (after-load-complete)="onPdfLoadComplete($event)"
    style="width: 1px; height: 1px; opacity: 0.01"
  ></pdf-viewer>

  <div class="split-layout" *ngIf="pdfLoaded">
    <div class="meta-panel">
      <div
        *ngFor="let section of resSections; let i = index"
        class="meta-item"
        (click)="jumpToSectionPage(section.start, i)"
      >
        <div class="meta-header">
          <ng-container *ngIf="editingIndex !== i">
            <span class="meta-title"> {{ section.name }} </span>
            <span class="meta-edit" (click)="enableEdit(i, $event)">✏️</span>
          </ng-container>

          <ng-container *ngIf="editingIndex === i">
            <input
              [(ngModel)]="resSections[i].name"
              (click)="$event.stopPropagation()"
              (keydown.enter)="disableEdit(i)"
              class="meta-input"
            />
            <button class="meta-confirm" (click)="disableEdit(i)">✅</button>
          </ng-container>
        </div>

        <div *ngIf="isExpanded(i)" class="meta-details">
          <ng-container *ngIf="editingIndex !== i">
            Page: {{ section.start }}<span *ngIf="section.end">
              - {{ section.end }}</span
            >
          </ng-container>
        </div>
      </div>
    </div>

    <!-- 📄 RIGHT: PDF strip -->
    <div class="pdf-strip-wrapper">
      <!-- 🔍 Focused Zoom Controls -->
      <div class="zoom-controls" *ngIf="focusedPageIndex !== null">
        <p style="font-size: 0.9rem; margin-bottom: 5px">
          Focused page: {{ pages[focusedPageIndex] }}
        </p>
        <button (click)="adjustFocusedZoom(-0.1)">−</button>
        <input
          type="range"
          [min]="0.25"
          [max]="2"
          [step]="0.05"
          [(ngModel)]="focusedZoom"
        />
        <button (click)="adjustFocusedZoom(0.1)">＋</button>
      </div>

      <div class="pdf-strip" #pdfStrip>
        <div
          *ngFor="let line of splitLines; let i = index"
          class="drag-line"
          [ngStyle]="{ transform: 'translateX(' + line.x + 'px)' }"
          cdkDrag
          [cdkDragLockAxis]="'x'"
          (cdkDragStarted)="onDragStart(i)"
          (cdkDragEnded)="onDragEnd($event, i)"
        ></div>

        <ng-container *ngFor="let page of pages; let i = index">
          <div class="snap-target debug" #snapTarget></div>
          <div
            class="pdf-box"
            [ngClass]="{ 'focused': focusedPageIndex === i }"
            (click)="toggleFocus(i)"
          >
            <pdf-viewer
              class="pdf-viewer"
              [src]="pdfSrc"
              [zoom]="focusedPageIndex === i ? focusedZoom : baseZoom"
              [page]="page"
              [show-all]="false"
              [original-size]="false"
              [render-text]="true"
              [ngStyle]="{
  transform: 'scale(' + (focusedPageIndex === i ? focusedZoom : baseZoom) + ')',
  'transform-origin': 'top center',
  'margin': '0 auto',
  'width': '300px',
  'height': '400px'
}"
            ></pdf-viewer>
          </div>
        </ng-container>

        <div class="snap-target debug" #snapTarget></div>
      </div>
    </div>
  </div>
  <div class="split-actions">
    <button class="action-btn left" (click)="onSaveSplit()">
      💾 Save New Split
    </button>
    <button class="action-btn right">⬇️ Download Split Files</button>
  </div>
</div>
